<main class="checkout-shell">
  <section class="checkout-head">
    <p class="kicker">Checkout</p>
    <h1>Confirm Delivery Details</h1>
  </section>

  @if (orderPlaced) {
    <section class="success-box">
      <h2>Order received successfully</h2>
      <p>
        Order <strong>{{ confirmedOrderReference }}</strong> confirmed via
        <strong>{{ confirmedPaymentMode }}</strong>.
      </p>

      <article class="confirmation-card" aria-label="WhatsApp confirmation image card">
        <img src="videos/greenspoonlogo.jpeg" alt="Green Spoon order confirmation" />
        <div>
          <p class="label">ORDER RECEIVED</p>
          <h3>{{ confirmedCustomerName }}</h3>
          <p>Ref: {{ confirmedOrderReference }}</p>
          <p>Total: INR {{ confirmedTotal }}</p>
          <p>Thank you for ordering from Green Spoon.</p>
        </div>
      </article>

      <p class="manual-note">
        Manually send the above confirmation card image/screenshot to customer on WhatsApp.
      </p>

      <div class="success-actions">
        <button type="button" (click)="openCustomerWhatsAppConfirmation()">
          Open Customer WhatsApp
        </button>
        <button type="button" class="secondary" (click)="copyConfirmationMessage()">
          Copy Confirmation Message
        </button>
        <a routerLink="/menu">Order More</a>
      </div>
    </section>
  } @else if (items().length === 0) {
    <section class="empty-box">
      <h2>No items to checkout</h2>
      <p>Add items in your cart first.</p>
      <a routerLink="/menu">Go To Menu</a>
    </section>
  } @else {
    <section class="checkout-layout">
      <form class="details-card" aria-label="Delivery details">
        <h2>Delivery Address</h2>

        <label>
          Full Name
          <input type="text" placeholder="Enter your name" [(ngModel)]="customerName" name="customerName" />
        </label>

        <label>
          Phone Number
          <input type="tel" placeholder="Enter your phone number" [(ngModel)]="customerPhone" name="customerPhone" />
        </label>

        <label>
          Email (optional)
          <input type="email" placeholder="Enter your email" [(ngModel)]="customerEmail" name="customerEmail" />
        </label>

        <label>
          Address Line
          <input type="text" placeholder="House / Street / Landmark" [(ngModel)]="addressLine" name="addressLine" />
        </label>

        <label>
          City
          <input type="text" placeholder="City" [(ngModel)]="city" name="city" />
        </label>

        <label>
          Notes
          <textarea rows="3" placeholder="Any delivery instructions" [(ngModel)]="notes" name="notes"></textarea>
        </label>
      </form>

      <aside class="summary-card">
        <h2>Bill Summary</h2>

        @for (item of items(); track item.id) {
          <div class="item-line">
            <span>{{ item.name }} x {{ item.quantity }}</span>
            <strong>INR {{ item.price * item.quantity }}</strong>
          </div>
        }

        <div class="line"><span>Subtotal</span><strong>INR {{ subtotal() }}</strong></div>
        <div class="line"><span>Delivery</span><strong>INR {{ deliveryFee() }}</strong></div>
        <div class="line"><span>Tax (5%)</span><strong>INR {{ tax() }}</strong></div>
        <div class="line total"><span>Total Payable</span><strong>INR {{ total() }}</strong></div>

        <div class="payment-methods">
          <p>Payment Method</p>
          <label>
            <input type="radio" name="paymentMethod" value="razorpay" [(ngModel)]="paymentMethod" />
            Razorpay
          </label>
          <label>
            <input type="radio" name="paymentMethod" value="whatsapp" [(ngModel)]="paymentMethod" />
            WhatsApp Pay (UPI via chat)
          </label>
        </div>

        @if (paymentMethod === 'razorpay') {
          <button type="button" [disabled]="isProcessing" (click)="startPayment()">
            {{ isProcessing ? 'Processing...' : 'Pay With Razorpay' }}
          </button>
        } @else {
          <button type="button" [disabled]="isProcessing" (click)="startPayment()">
            Send WhatsApp Pay Request
          </button>

          @if (paymentRequested) {
            <button type="button" class="secondary" (click)="confirmWhatsAppPayment()">
              Confirm Payment Received & Place Order
            </button>
          }
        }

        @if (statusMessage) {
          <p class="status-note">{{ statusMessage }}</p>
        }
      </aside>
    </section>
  }
</main>
